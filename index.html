<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guest Tracking System</title>
    <link rel="stylesheet" href="style.css">

    <!-- Firebase CDN links with type="module" -->
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
</head>
<body>
    <header>
        <h1>Guest Tracking System</h1>
    </header>

    <!-- Login Section (Visible initially) -->
    <div class="container" id="loginContainer">
        <h2>Admin Login</h2>
        <input type="email" id="adminEmail" placeholder="Enter Email">
        <input type="password" id="adminPassword" placeholder="Enter Password">
        <button onclick="adminLogin()">Login</button>
    </div>

    <!-- Guest Check-in Request Section (Visible after login) -->
    <div class="container" id="guestContainer" style="display: none;">
        <h2>Guest Check-in Request</h2>
        <select id="guestSelect"></select>
        <button onclick="requestCheckIn()">Request Check-In</button>
        <h2>Pending Check-in Requests</h2>
        <ul id="pendingCheckInList"></ul>
    </div>

    <!-- Admin Section (Only Visible After Login) -->
    <div class="container" id="adminContainer" style="display: none;">
        <h2>Manage Guest List</h2>
        <input type="text" id="guestName" placeholder="Enter Guest Name">
        <button onclick="addGuest()">Add Guest</button>

        <h2>Current Guests Inside</h2>
        <ul id="guestList"></ul> <!-- List of current guests inside the venue -->

        <h2>Current Guests in Venue</h2>
        <ul id="currentGuestsInVenue"></ul> <!-- List of checked-in guests -->

        <h2>Search Guest</h2>
        <input type="text" id="searchName" placeholder="Search by Name">
        <button onclick="searchGuest()">Search</button>
        <p id="searchResult"></p> <!-- Display search result -->

        <button onclick="adminLogout()">Logout</button>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, update, remove } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyB48zrln_P9SEIngjf58Yopkpstsac6uFM",
          authDomain: "guest-list-8ee99.firebaseapp.com",
          databaseURL: "https://guest-list-8ee99-default-rtdb.asia-southeast1.firebasedatabase.app",  // Use your correct database URL
          projectId: "guest-list-8ee99",
          storageBucket: "guest-list-8ee99.appspot.com",
          messagingSenderId: "907423161396",
          appId: "1:907423161396:web:52b2733d12a89a4cdfbe61",
          measurementId: "G-2199LVL65J"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Admin Login
        window.adminLogin = function() {
            const email = document.getElementById("adminEmail").value;
            const password = document.getElementById("adminPassword").value;
            signInWithEmailAndPassword(auth, email, password)
                .then(() => {
                    document.getElementById("loginContainer").style.display = "none";  // Hide login
                    document.getElementById("adminContainer").style.display = "block";  // Show admin controls
                    loadGuestList();
                    loadCurrentGuestsInVenue();  // Load current guests in the venue
                    loadPendingCheckIns();
                })
                .catch(error => alert(error.message));
        }

        // Admin Logout
        window.adminLogout = function() {
            signOut(auth).then(() => {
                document.getElementById("adminContainer").style.display = "none";
                document.getElementById("loginContainer").style.display = "block";  // Show login on logout
            });
        }

        // Add Guest
        window.addGuest = function() {
            const guestName = document.getElementById("guestName").value;
            if (guestName) {
                // Add guest to the "guests" node in the database
                set(ref(database, "guests/" + guestName), { checkedIn: false });
                document.getElementById("guestName").value = ""; // Clear the input
                loadGuestList(); // Reload the guest list
                loadCurrentGuestsInVenue(); // Reload current checked-in guests
            }
        }

        // Load Guests into Dropdown and Guest List
        function loadGuestList() {
            const guestSelect = document.getElementById("guestSelect");
            const guestList = document.getElementById("guestList");

            // Clear both dropdown and the guest list
            guestSelect.innerHTML = "";
            guestList.innerHTML = "";

            // Fetch the guests from the Firebase database
            get(ref(database, "guests")).then(snapshot => {
                snapshot.forEach(child => {
                    // Add guests to dropdown
                    let option = document.createElement("option");
                    option.textContent = child.key;
                    guestSelect.appendChild(option);

                    // Add guests to the list of current guests on the page
                    let listItem = document.createElement("li");
                    listItem.textContent = child.key;
                    guestList.appendChild(listItem);
                });
            });
        }

        // Load Current Checked-in Guests
        function loadCurrentGuestsInVenue() {
            const currentGuestsInVenue = document.getElementById("currentGuestsInVenue");
            currentGuestsInVenue.innerHTML = "";  // Clear the list

            // Fetch the checked-in guests from the Firebase database
            get(ref(database, "guests")).then(snapshot => {
                snapshot.forEach(child => {
                    if (child.val().checkedIn) {
                        let listItem = document.createElement("li");
                        listItem.textContent = child.key;
                        currentGuestsInVenue.appendChild(listItem);
                    }
                });
            });
        }

        // Request Check-in
        window.requestCheckIn = function() {
            const guestName = document.getElementById("guestSelect").value;
            if (guestName) {
                // Mark the guest as checked-in in the "checkInRequests" node
                set(ref(database, "checkInRequests/" + guestName), true);
            }
        }

        // Load Pending Check-in Requests
        function loadPendingCheckIns() {
            const pendingList = document.getElementById("pendingCheckInList");
            onValue(ref(database, "checkInRequests"), snapshot => {
                pendingList.innerHTML = "";
                snapshot.forEach(child => {
                    let listItem = document.createElement("li");
                    listItem.textContent = child.key;
                    let approveBtn = document.createElement("button");
                    approveBtn.textContent = "Approve";
                    approveBtn.onclick = () => approveCheckIn(child.key);
                    listItem.appendChild(approveBtn);
                    pendingList.appendChild(listItem);
                });
            });
        }

        // Approve Check-in
        window.approveCheckIn = function(guestName) {
            update(ref(database, "guests/" + guestName), { checkedIn: true });
            remove(ref(database, "checkInRequests/" + guestName));
            loadGuestList(); // Reload the guest list to reflect changes
            loadCurrentGuestsInVenue(); // Reload the checked-in guests list
            loadPendingCheckIns(); // Reload the pending check-ins
        }

        // Search for a Guest
        window.searchGuest = function() {
            const searchName = document.getElementById("searchName").value.trim();
            const searchResult = document.getElementById("searchResult");
            
            if (searchName) {
                get(ref(database, "guests/" + searchName)).then(snapshot => {
                    if (snapshot.exists()) {
                        const guest = snapshot.val();
                        if (guest.checkedIn) {
                            searchResult.textContent = `${searchName} is currently checked in.`;
                            searchResult.style.color = "green";
                        } else {
                            searchResult.textContent = `${searchName} is not checked in yet.`;
                            searchResult.style.color = "orange";
                        }
                    } else {
                        searchResult.textContent = `${searchName} not found in the database.`;
                        searchResult.style.color = "red";
                    }
                });
            }
        }

        // Remove Guest from Database and Venue
        window.removeGuest = function(guestName) {
            // Remove from guests and current venue
            remove(ref(database, "guests/" + guestName));
            loadGuestList(); // Reload the guest list
            loadCurrentGuestsInVenue(); // Reload checked-in guests
        }
    </script>
</body>
</html>

